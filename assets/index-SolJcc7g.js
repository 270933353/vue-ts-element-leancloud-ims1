import{d as oe,ah as re,z as p,m as H,aF as se,ap as k,L as f,a3 as S,ai as ne,o as x,c as de,b as l,w as r,u as n,A,J as g,x as I,f as R,a as q,t as ie,aH as ue,S as B,aI as ce,aJ as pe,aK as me,aL as fe,a9 as _e,C as ve,ad as ge,D as ye,aj as be,at as he,aE as we,aw as Ae,ax as ke,aM as xe,G as Ce,aN as Ve,_ as Ie}from"./index-59vPsdGi.js";import{u as Re}from"./el-drawer-4jTvGZza.js";/* empty css                      *//* empty css                        *//* empty css                   *//* empty css                */import{f as je}from"./validator-qMdRg1PI.js";const Ye={style:{flex:"auto"}},Ee=oe({__name:"index",setup(De){re(()=>{j()});let h=p([]),u=p(1),_=p(10),P=H(()=>h.value.length);const U=H(()=>{const a=(u.value-1)*_.value,e=a+_.value;return h.value.slice(a,e)}),j=async()=>{await se().then(a=>{h.value=a.map(e=>({...e.attributes,objectId:e.id,createdAt:k(e.createdAt).format("YYYY-MM-DD HH:mm:ss"),updatedAt:k(e.updatedAt).format("YYYY-MM-DD HH:mm:ss")}),e=>{f({type:"error",message:"获取全部角色信息失败 "+e})})})},K=a=>{u.value=a},N=a=>{_.value=a};let i=p(),d=p(!1),s=S({objectId:"",name:"",description:"",permissionArr:[]});const T=S({name:[{required:!1,trigger:"blur",validator:je}]}),O=()=>{d.value=!0,Object.assign(s,{objectId:"",name:"",description:"",permissionArr:[]}),ue().then(a=>{w.value=a,s.permissionArr=a}),B(()=>{var a,e;(a=i==null?void 0:i.value)==null||a.clearValidate("name"),(e=i==null?void 0:i.value)==null||e.clearValidate("description")})},Y=(a,e)=>(a.forEach(t=>{t.select&&t.level==3&&e.push(t.id),t.children&&t.children.length>0&&Y(t.children,e)}),e),Q=a=>{d.value=!0,s.permissionArr.length=0,Object.assign(s,a),console.log("roleForm",s),ce(s.objectId).then(e=>{console.log("per",e),w.value=e,s.permissionArr=e,D.value=Y(s.permissionArr,[])}),B(()=>{var e,t;(e=i==null?void 0:i.value)==null||e.clearValidate("name"),(t=i==null?void 0:i.value)==null||t.clearValidate("description")})},E=(a,e)=>(console.log(a),a.forEach(t=>{e.includes(t.id)?t.select=!0:t.select=!1,t.children&&t.children.length>0&&E(t.children,e)}),w.value.data=a,w.value),L=async a=>{if(!a)return;let e=C.value.getCheckedKeys(),t=C.value.getHalfCheckedKeys(),v=e.concat(t);s.permissionArr=E(w.value,v),await a.validate(async c=>{c?s.objectId?pe(s).then(()=>{d.value=!1,f({type:"success",message:"更新成功"}),window.location.reload()},b=>{d.value=!1,f({type:"error",message:"更新失败 "+b})}):me(s).then(()=>{d.value=!1,f({type:"success",message:"添加成功"}),window.location.reload()},b=>{d.value=!1,f({type:"error",message:"添加失败 "+b})}):f({type:"error",message:"表单校验失败"})})},J=async a=>{await fe(a).then(()=>{d.value=!1,f({type:"success",message:"删除成功"}),j(),u.value=h.value.length>1?u.value:u.value-1},e=>{d.value=!1,f({type:"error",message:"删除失败 "+e})})};let D=p([]),w=p(),C=p();const $={children:"children",label:"title"};let y=p("");const G=async a=>{await Ve("name",a).then(e=>{h.value=e.map(t=>({...t.attributes,objectId:t.id,createdAt:k(t.createdAt).format("YYYY-MM-DD HH:mm:ss"),updatedAt:k(t.updatedAt).format("YYYY-MM-DD HH:mm:ss")}))})},W=async a=>{G(a)};let z=Re();const X=()=>{z.setRefresh(!z.refresh)};return(a,e)=>{const t=_e,v=ve,c=ge,b=ye,M=be,m=he,Z=we,F=Ae,ee=ke,ae=xe,le=Ce,V=ne("has");return x(),de("div",null,[l(M,{style:{height:"80px"}},{default:r(()=>[l(b,{inline:!0,class:"form"},{default:r(()=>[l(v,{label:"角色搜索"},{default:r(()=>[l(t,{placeholder:"请输入搜索关键字",modelValue:n(y),"onUpdate:modelValue":e[0]||(e[0]=o=>A(y)?y.value=o:y=o)},null,8,["modelValue"])]),_:1}),l(v,null,{default:r(()=>[l(c,{type:"primary",disabled:!n(y),onClick:e[1]||(e[1]=o=>W(n(y)))},{default:r(()=>[g(" 搜索 ")]),_:1},8,["disabled"]),l(c,{type:"primary",onClick:X},{default:r(()=>[g("重置")]),_:1})]),_:1})]),_:1})]),_:1}),l(M,{style:{margin:"10px 0px"}},{default:r(()=>[I((x(),R(c,{type:"primary",onClick:O},{default:r(()=>[g(" 添加角色 ")]),_:1})),[[V,"btn.role.add"]]),l(F,{border:"",style:{margin:"10px 0px"},data:U.value},{default:r(()=>[l(m,{type:"selection",align:"center",fixed:"left"}),l(m,{label:"#",align:"center",type:"index"}),l(m,{label:"ID",align:"center","show-overflow-tooltip":"",prop:"objectId"}),l(m,{label:"角色名称",align:"center",prop:"name","show-overflow-tooltip":""}),l(m,{label:"角色描述",align:"center",prop:"description","show-overflow-tooltip":""}),l(m,{label:"创建时间",align:"center","show-overflow-tooltip":"",prop:"createdAt"}),l(m,{label:"更新时间",align:"center","show-overflow-tooltip":"",prop:"updatedAt"}),l(m,{label:"操作",width:"250px",align:"center",fixed:"right"},{default:r(({row:o})=>[I((x(),R(c,{type:"primary",size:"small",onClick:te=>Q(o)},{default:r(()=>[g(" 编辑 ")]),_:2},1032,["onClick"])),[[V,"btn.role.edit"]]),l(Z,{title:`确认删除${o.name}?`,width:"200px",onConfirm:te=>J(o.objectId)},{reference:r(()=>[I((x(),R(c,{type:"primary",size:"small"},{default:r(()=>[g(" 删除 ")]),_:1})),[[V,"btn.role.remove"]])]),_:2},1032,["title","onConfirm"])]),_:1})]),_:1},8,["data"]),l(ee,{"current-page":n(u),"onUpdate:currentPage":e[2]||(e[2]=o=>A(u)?u.value=o:u=o),"page-size":n(_),"onUpdate:pageSize":e[3]||(e[3]=o=>A(_)?_.value=o:_=o),"page-sizes":[10,20,50],layout:"prev, pager, next, jumper,->,sizes,total",total:n(P),background:"",onCurrentChange:K,onSizeChange:N},null,8,["current-page","page-size","total"])]),_:1}),l(le,{modelValue:n(d),"onUpdate:modelValue":e[8]||(e[8]=o=>A(d)?d.value=o:d=o)},{header:r(()=>[q("h4",null,ie(n(s).objectId?"更新角色":"添加角色"),1)]),default:r(()=>[l(b,{model:n(s),rules:T,ref_key:"roleFormRef",ref:i},{default:r(()=>[l(v,{label:"角色名称",prop:"name"},{default:r(()=>[l(t,{placeholder:"角色名称",modelValue:n(s).name,"onUpdate:modelValue":e[4]||(e[4]=o=>n(s).name=o),disabled:!!n(s).objectId,clearable:""},null,8,["modelValue","disabled"])]),_:1}),l(v,{label:"角色描述",prop:"description"},{default:r(()=>[l(t,{placeholder:"角色描述",modelValue:n(s).description,"onUpdate:modelValue":e[5]||(e[5]=o=>n(s).description=o),clearable:""},null,8,["modelValue"])]),_:1}),l(v,{label:"角色权限",prop:"description"},{default:r(()=>[l(ae,{ref_key:"treeRef",ref:C,data:n(s).permissionArr,"show-checkbox":"","node-key":"id","default-expand-all":"","default-checked-keys":n(D),props:$},null,8,["data","default-checked-keys"])]),_:1})]),_:1},8,["model","rules"])]),footer:r(()=>[q("div",Ye,[l(c,{type:"primary",onClick:e[6]||(e[6]=o=>L(n(i)))},{default:r(()=>[g("保存")]),_:1}),l(c,{onClick:e[7]||(e[7]=o=>A(d)?d.value=!1:d=!1)},{default:r(()=>[g("取消")]),_:1})])]),_:1},8,["modelValue"])])}}}),Ue=Ie(Ee,[["__scopeId","data-v-575f9e8a"]]);export{Ue as default};
